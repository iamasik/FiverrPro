const apiVersion="4.0.1";chrome.runtime.onInstalled.addListener(function(){chrome.storage.sync.set({naft:!0}),chrome.storage.sync.set({fvui:!0}),chrome.storage.sync.set({unread_conversations_count:0}),chrome.storage.sync.set({unread_notifications_count:0}),chrome.alarms.create("naft",{periodInMinutes:1})}),chrome.runtime.onStartup.addListener(function(){chrome.storage.sync.get(["naft"],function(e){!0==e.naft?(chrome.alarms.create("naft",{periodInMinutes:1}),chrome.action.setBadgeText({text:""})):(chrome.action.setBadgeText({text:"OFF"}),chrome.action.setBadgeBackgroundColor({color:"#ec4899"}))}),chrome.storage.sync.set({unread_conversations_count:0}),chrome.storage.sync.set({unread_notifications_count:0})}),chrome.storage.onChanged.addListener(function(e,t){for(var a in e){var n=e[a];if("naft"==a&&(n.newValue?(chrome.alarms.create("naft",{periodInMinutes:1}),chrome.action.setBadgeText({text:""})):(chrome.alarms.clear("naft"),chrome.action.setBadgeText({text:"OFF"}),chrome.action.setBadgeBackgroundColor({color:"#ec4899"})),chrome.storage.sync.set({unread_conversations_count:0}),chrome.storage.sync.set({unread_notifications_count:0})),"unread_notifications_count"==a){if(n.newValue>0){var s={type:"basic",title:"Fiverr Pro",message:"You have unread notifications.",iconUrl:"images/notification-icon.png"};chrome.notifications.create(s),chrome.storage.sync.get(["unread_conversations_count"],function(e){chrome.action.setBadgeText({text:(e.unread_conversations_count+n.newValue).toString()}),chrome.action.setBadgeBackgroundColor({color:"#9d4edd"})})}else chrome.action.setBadgeText({text:""})}if("unread_conversations_count"==a){if(n.newValue>0){var s={type:"basic",title:"Fiverr Pro",message:"You have unread messages.",iconUrl:"images/notification-icon.png"};chrome.notifications.create(s),chrome.storage.sync.get(["unread_notifications_count"],function(e){chrome.action.setBadgeText({text:(e.unread_notifications_count+n.newValue).toString()}),chrome.action.setBadgeBackgroundColor({color:"#9d4edd"})})}else chrome.action.setBadgeText({text:""})}}}),chrome.alarms.onAlarm.addListener(function(){fetch("https://www.fiverr.com/notification_items/preview/0").then(e=>e.json()).then(e=>{chrome.storage.sync.set({unread_notifications_count:e.unread_notifications_count})}).catch(e=>{chrome.storage.sync.set({unread_notifications_count:0}),chrome.action.setBadgeText({text:""})}),fetch("https://www.fiverr.com/conversations/preview/0").then(e=>e.json()).then(e=>{chrome.storage.sync.set({unread_conversations_count:e.unread_conversations_count})}).catch(e=>{chrome.storage.sync.set({unread_conversations_count:0}),chrome.action.setBadgeText({text:""})})});var globalPort,tabIds=[],tabsLoaded=0,active=!1,searchMode="group",smIndex=0,urls=[],username="";function createTab(e){chrome.tabs.create({url:e,active:!1},e=>{tabIds.push(e.id),smIndex++})}function checkRank(e,t){let a=1;for(let n of e){if(t===n.seller_name)return a;a++}return null}function resetScrape(){active=!1,tabIds=[],tabsLoaded=0,smIndex=0,urls=[],username="",chrome.action.setIcon({path:"icon.png"})}chrome.runtime.onConnectExternal.addListener(function(e){e.onMessage.addListener(function(t){console.log("Message Received from Web",t),"4.0.1"!==t.version?(e.postMessage({status:"outdated"}),e.disconnect()):!1===active?(searchMode=t.searchMode,e.postMessage({status:"accepted"}),resetScrape(),active=!0,chrome.action.setIcon({path:"icon-red.png"}),globalPort=e,"group"==searchMode?t.urls.forEach(e=>{chrome.tabs.create({url:e,active:!1},e=>{tabIds.push(e.id)})}):(urls=t.urls,username=t.username,createTab(t.urls[smIndex]))):(e.postMessage({status:"busy"}),e.disconnect())})}),chrome.runtime.onMessage.addListener(function(e,t,a){if(e.status&&t.tab&&"group"===e.searchMode&&"group"===searchMode)console.log("[GROUP MODE] Message Received from Scraper",t.tab.id),tabIds.includes(t.tab.id)&&(tabsLoaded++,chrome.tabs.remove(t.tab.id)),tabsLoaded===tabIds.length&&active&&(globalPort.postMessage({status:"completed"}),globalPort.disconnect(),resetScrape());else if(e.status&&t.tab&&"single"===e.searchMode&&"single"===searchMode&&(console.log("[SINGLE MODE] Message Received from Scraper",t.tab.id),tabIds.includes(t.tab.id))){chrome.tabs.remove(t.tab.id);let n=checkRank(e.listings,username);if(null!=n){let s=48*(e.page-1)+n;globalPort.postMessage({status:"completed",found:!0,rank:s,page:e.page}),globalPort.disconnect(),resetScrape()}else smIndex<5?(globalPort.postMessage({status:"update",page:smIndex}),createTab(urls[smIndex])):(globalPort.postMessage({status:"completed",found:!1}),globalPort.disconnect(),resetScrape())}}),chrome.runtime.onMessageExternal.addListener(function(e,t,a){console.log("Message Received from Web",e),"reset"===e.action&&(resetScrape(),a({status:"completed"}))});